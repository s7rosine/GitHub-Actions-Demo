name: DevOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  build_and_push_images:
    name: Build and Push Docker Images to DockerHub
    runs-on: [self-hosted, s8]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Checkov Scan with Config File
        run: |
          ls -l
          echo "üîç Running Checkov .checkov.yaml config"
          cat .checkov.yaml
          checkov -f s9/app01/api.Dockerfile --config-file .checkov.yaml
          checkov -f s9/app01/db.Dockerfile --config-file .checkov.yaml
          checkov -f s9/app01/frontend.Dockerfile --config-file .checkov.yaml

      - name: Build Docker Images (API, DB, Frontend)
        working-directory: s9/app01
        run: |
          sudo docker build -f api.Dockerfile -t $API_IMAGE .
          sudo docker build -f db.Dockerfile -t $DB_IMAGE .
          sudo docker build -f frontend.Dockerfile -t $FRONTEND_IMAGE .
          sudo docker images

      - name: Scan Docker Images with Trivy
        run: |
          echo "üîç Scanning API image..."
          trivy image --severity MEDIUM,HIGH,CRITICAL --no-progress $API_IMAGE

          echo "üîç Scanning DB image..."
          trivy image --severity MEDIUM,HIGH,CRITICAL --no-progress $DB_IMAGE

          echo "üîç Scanning Frontend image..."
          trivy image --severity MEDIUM,HIGH,CRITICAL --no-progress $FRONTEND_IMAGE
